<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>任务列表</title>
    <!-- Tell the browser to be responsive to screen width -->
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <!-- Bootstrap 3.3.6 -->
    <link rel="stylesheet" href="resource/admin/bootstrap/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="resource/admin/plugins/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- Ionicons -->
    <link rel="stylesheet" href="resource/admin/plugins/ajax/libs/ionicons/2.0.1/css/ionicons.min.css">
    <!-- jvectormap -->
    <link rel="stylesheet" href="resource/admin/plugins/jvectormap/jquery-jvectormap-1.2.2.css">
    <!-- DataTables -->
    <link rel="stylesheet" href="resource/admin/plugins/datatables/dataTables.bootstrap.css">
    <!-- Select2 -->
    <link rel="stylesheet" href="resource/admin/plugins/select2/select2.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="resource/admin/dist/css/AdminLTE.min.css">
    <!-- AdminLTE Skins. Choose a skin from the css/skins
         folder instead of downloading all of them to reduce the load. -->
    <link rel="stylesheet" href="resource/admin/dist/css/skins/_all-skins.min.css">

    <!-- layer ui -->
    <link rel="stylesheet" href="resource/plugins/layer-v2.1/layer/skin/layer.css">
    <link rel="stylesheet" href="resource/plugins/backtop/material-scrolltop.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="resource/plugins/cms/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="resource/plugins/cms/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <style>
        .required{color: red;}
    </style>

</head>
<body class="hold-transition skin-blue sidebar-mini">
<div class="wrapper">

    <header class="main-header">

        <!-- Logo -->
        <a href="index.html" class="logo">
            <!-- mini logo for sidebar mini 50x50 pixels -->
            <span class="logo-mini"><b>Job</b></span>
            <!-- logo for regular state and mobile devices -->
            <span class="logo-lg"><b>Blades</b> - Job</span>
        </a>

        <!-- Header Navbar: style can be found in header.less -->
        <nav class="navbar navbar-static-top">
            <!-- Sidebar toggle button-->
            <a href="#" class="sidebar-toggle" data-toggle="offcanvas" role="button">
                <span class="sr-only">Toggle navigation</span>
            </a>
            <!-- Navbar Right Menu -->
            <div class="navbar-custom-menu">
                <ul class="nav navbar-nav">
                    <!-- Messages: style can be found in dropdown.less-->


                    <!-- User Account: style can be found in dropdown.less -->
                    <li class="dropdown user user-menu">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                            <img src="resource/admin/dist/img/user2-160x160.jpg" class="user-image" alt="User Image">
                            <span class="hidden-xs">Welcome，admin</span>
                        </a>
                        <ul class="dropdown-menu">
                            <!-- User image -->
                            <li class="user-header">
                                <img src="resource/admin/dist/img/user2-160x160.jpg" class="img-circle" alt="User Image">
                                <p>
                                    admin
                                </p>
                            </li>
                            <!-- Menu Body -->

                            <!-- Menu Footer-->
                            <li class="user-footer">
                                <div class="pull-left">
                                    <a href="#" class="btn btn-default btn-flat">设置</a>
                                </div>
                                <div class="pull-right">
                                    <a href="#" class="btn btn-default btn-flat">注销</a>
                                </div>
                            </li>
                        </ul>
                    </li>
                    <!-- Control Sidebar Toggle Button -->
                    <li>
                        <a href="#" data-toggle="control-sidebar"><i class="fa fa-gears"></i></a>
                    </li>
                </ul>
            </div>

        </nav>
    </header>
    <!-- Left side column. contains the logo and sidebar -->
    <aside class="main-sidebar">
        <!-- sidebar: style can be found in sidebar.less -->
        <section class="sidebar">
            <!-- Sidebar user panel -->
            <div class="user-panel">
                <div class="pull-left image">
                    <img src="resource/admin/dist/img/user2-160x160.jpg" class="img-circle" alt="User Image">
                </div>
                <div class="pull-left info">
                    <p>admin</p>
                    <a href="#"><i class="fa fa-circle text-success"></i> Online</a>
                </div>
            </div>
            <!-- sidebar menu: : style can be found in sidebar.less -->
            <ul class="sidebar-menu">
                <li class="header">任务管理系统</li>
                <li class="treeview" id="menu-1" code="main-index">
                    <a href="index.html">
                        <i class="fa fa-dashboard"></i> <span>首页</span></i>
                    </a>
                </li>
                <li class="treeview" id="menu-2" code="storeroom-manage">
                    <a href="#">
                        <i class="fa fa-clock-o"></i>
                        <span>任务管理</span>
                        <i class="fa fa-angle-left pull-right"></i>
                    </a>
                    <ul class="treeview-menu">
                        <li id="menu-21" code="job-list" pid="menu-2"><a href="#"><i class="fa fa-circle-o"></i> 任务列表</a></li>
                    </ul>
                </li>
                <li id="menu-3" code="intf-doc">
                    <a href="swagger-ui.html" target="_blank">
                        <i class="fa fa-book"></i> <span>接口文档</span></i>
                    </a>
                </li>
            </ul>
        </section>
        <!-- /.sidebar -->
    </aside>

    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h1>
                任务管理
                <small>任务列表</small>
            </h1>
            <ol class="breadcrumb">
                <li><a href="#"><i class="fa fa-dashboard"></i> 任务管理</a></li>
                <li class="active">任务列表</li>
            </ol>
        </section>

        <!-- Main content -->
        <section class="content">

            <div class="row">
                <div class="col-md-12">
                    <div class="box box-primary">
                        <div class="box-header with-border">
                            <h3 class="box-title">查询条件</h3>

                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i
                                        class="fa fa-minus"></i>
                                </button>
                            </div>
                            <!-- /.box-tools -->
                        </div>
                        <!-- /.box-header -->
                        <div class="box-body">

                            <!-- form start -->
                            <form class="form-horizontal">
                                <div class="box-body">
                                    <div class="form-group">
                                        <label class="col-sm-1 control-label">任务名称：</label>
                                        <div class="col-sm-2">
                                            <input type="text" class="form-control" id="jobName"
                                                   placeholder="">
                                        </div>

                                        <label class="col-sm-1 control-label">任务分组：</label>
                                        <div class="col-sm-2">
                                            <input type="text" class="form-control" id="jobGroup"
                                                   placeholder="">
                                        </div>

                                        <label class="col-sm-1 control-label">任务状态：</label>
                                        <div class="col-sm-2">
                                            <select  class="form-control" id="status">
                                                <option value="">全部</option>
                                                <option value="1">正常</option>
                                                <option value="2">暂停</option>
                                                <option value="3">完成</option>
                                                <option value="4">错误</option>
                                                <option value="5">阻塞</option>
                                            </select>
                                        </div>

                                        <div class="col-sm-2">
                                            <div class="pull-right">
                                                <button id="btnAddPage" type="button" class="btn btn-primary"><i
                                                        class="glyphicon glyphicon-plus"></i>添加任务
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-md-offset-1 col-md-10">
                                            <button type="button" class="btn btn-primary" id="searchBtn"><i
                                                    class="glyphicon glyphicon-search"></i>查询
                                            </button>
                                            <button type="reset" class="btn btn-default">&nbsp;重置&nbsp;</button>
                                        </div>
                                    </div>
                                </div>
                                <!-- /.box-footer -->
                            </form>
                        </div>
                        <!-- /.box-body -->
                    </div>
                    <!-- /.box -->
                </div>
                <!-- /.col -->
            </div>
            <div class="row">
                <div class="col-xs-12">
                    <div class="box box-primary box-solid">
                        <div class="box-header">
                            <h3 class="box-title">查询结果</h3>
                        </div>
                        <!-- /.box-header -->
                        <div class="box-body">
                            <!-- 定义一个表格元素 -->
                            <table id="example" class="table table-striped table-bordered">
                                <thead>
                                <tr>
                                    <th>编号</th>
                                    <th>任务名称</th>
                                    <th>任务分组</th>
                                    <th>所属系统</th>
                                    <th>状态</th>
                                    <th>最后开始时间</th>
                                    <th>最后结束时间</th>
                                    <th>下次执行时间</th>
                                    <th>操作</th>
                                </tr>
                                </thead>
                                <tbody></tbody>
                                <!-- tbody是必须的 -->
                            </table>
                        </div>
                        <!-- /.box-body -->
                    </div>
                    <!-- /.box -->

                </div>
                <!-- /.col -->
            </div>

        </section>
        <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->

    <footer class="main-footer">
        <div class="pull-right hidden-xs">
            <b>Version</b> 1.0
        </div>
        <strong>Blades Job <a href="#">blades.iusofts.com</a></strong>
    </footer>

    <!-- Control Sidebar -->
    <aside class="control-sidebar control-sidebar-dark">
        <!-- Create the tabs -->
        <ul class="nav nav-tabs nav-justified control-sidebar-tabs">
            <li><a href="#control-sidebar-home-tab" data-toggle="tab"><i class="fa fa-home"></i></a></li>
            <li><a href="#control-sidebar-settings-tab" data-toggle="tab"><i class="fa fa-gears"></i></a></li>
        </ul>
        <!-- Tab panes -->
        <div class="tab-content">
            <!-- Home tab content -->
            <div class="tab-pane" id="control-sidebar-home-tab">

            </div>
            <!-- /.tab-pane -->
            <!-- Stats tab content -->
            <div class="tab-pane" id="control-sidebar-stats-tab">Stats Tab Content</div>
            <!-- /.tab-pane -->
            <!-- Settings tab content -->
            <div class="tab-pane" id="control-sidebar-settings-tab">
            </div>
            <!-- /.tab-pane -->
        </div>
    </aside>
    <!-- /.control-sidebar -->
    <!-- Add the sidebar's background. This div must be placed
         immediately after the control sidebar -->
    <div class="control-sidebar-bg"></div>

    <!-- Material button -->
    <button class="material-scrolltop" type="button"></button>

</div>
<!-- ./wrapper -->

<!-- jQuery 2.2.0 -->
<script src="resource/admin/plugins/jQuery/jQuery-2.2.0.min.js"></script>
<!-- Bootstrap 3.3.6 -->
<script src="resource/admin/bootstrap/js/bootstrap.min.js"></script>
<!-- DataTables -->
<script src="resource/admin/plugins/datatables/jquery.dataTables.min.js"></script>
<script src="resource/admin/plugins/datatables/dataTables.bootstrap.min.js"></script>
<!-- SlimScroll -->
<script src="resource/admin/plugins/slimScroll/jquery.slimscroll.min.js"></script>
<!-- FastClick -->
<script src="resource/admin/plugins/fastclick/fastclick.js"></script>
<!-- AdminLTE App -->
<script src="resource/admin/dist/js/app.min.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="resource/admin/dist/js/demo.js"></script>
<!-- layer ui -->
<script src="resource/plugins/layer-v2.1/layer/layer.js"></script>
<!-- 菜单 -->
<script src="resource/admin/menu.js"></script>
<!-- 返回顶部 -->
<script src="resource/plugins/backtop/material-scrolltop.js"></script>
<!-- Select2 -->
<script src="resource/admin/plugins/select2/select2.full.min.js"></script>
<!-- My97DatePicker -->
<script src="resource/plugins/calendar/WdatePicker.js"></script>

<!-- 全局变量 -->
<script type="text/javascript">
    var ctx = '';
</script>

<!-- 返回顶部 -->
<script>
    $(document).ready(function() {
        try {
            $('body').materialScrollTop({
                revealElement: 'header',
                revealPosition: 'bottom',
                onScrollEnd: function () {
                    console.log('Scrolling End');
                }
            });
        } catch (e) {
        }

        //Initialize Select2 Elements
        $(".select2").select2();

        setInterval('listCountdown()',1000); //指定1秒刷新一次
    });

</script>

<!-- page script -->
<script type="text/javascript" src="config/config.js"></script>
<script type="text/javascript" src="resource/common/js/page-0.1.js"></script>
<script>
    $(function () {
        //load menu
        choiceMenu("job-list");

        /*分页查询开始*/
        window.page = new Page().init({
            tableId: "example",
            url: jobListApi,
            columns: [
                {
                    data: "id"
                },
                {
                    data: "jobName"
                },
                {
                    data: "jobGroup"
                },
                {
                    data: "sysCode"
                },
                {
                    data: "status"
                },
                {
                    data: "lastStartTime",
                    defaultContent: "-"
                },
                {
                    data: "lastEndTime",
                    defaultContent: "-"
                },
                {
                    data: "nextFireTime",
                    defaultContent: "-"
                },
                {
                    data: "id"
                }
            ],
            columnDefs: [{
                // 定义操作列,######以下是重点########
                "targets": 1,//操作按钮目标列
                "data": null,
                "render": function (data,
                                    type, row) {
                    if(row.aliasName){
                        return '<a title="'+row.aliasName+'" href="javascript:detail('+row.id+')">'+ data +'</a>';
                    }
                    return '<a title="无别名" href="javascript:detail('+row.id+')">'+ data +'</a>';
                }
            },{
                "targets": 4,//操作按钮目标列
                "data": null,
                "render": function (data,
                                    type, row) {
                    switch (data){
                        case 1 :
                            return '<font color="green">正常</font>';
                        case 2 :
                            return '<font color="#f3d732">暂停</font>';
                        case 3 :
                            return '<font color="#000000">完成</font>';
                        case 4 :
                            if(row.maxRetryNum>0){
                                return '<font color="red">错误('+ row.retriedNum +'/'+ row.maxRetryNum +')</font>';
                            }else{
                                return '<font color="red">错误</font>';
                            }
                        case 5 :
                            return '<font color="#32cd32">阻塞</font>';
                        default :
                            return '异常';
                    }
                }
            },{
                "targets": 7,//操作按钮目标列
                "data": null,
                "render": function (data,
                                    type, row) {
                    var isRetryEnd = row.retriedNum==row.maxRetryNum;
                    return '<div data="'+ data +'" status="'+ row.status +'" isRetryEnd="'+isRetryEnd+'" class="nextFireTime"></div>';
                }
            }, {
                "targets": 8,//操作按钮目标列
                "data": null,
                "render": function (data,
                                    type, row) {
                    var id = '"' + row.id
                        + '"';
                    var html = '';
                    /*html += "<button class='btn btn-default btn-xs'  onclick='detail("
                        + id
                        + ")'><i class='glyphicon glyphicon-info-sign'></i> 详情</button>&nbsp;";*/
                    html += "<button class='btn btn-default btn-xs'  onclick='showLog("
                        + id
                        + ")'><i class='fa fa-file-text-o'></i> 日志</button>&nbsp;";
                    html += "<button class='btn btn-xs btn-primary' onclick='edit("
                        + id
                        + ")'><i class='glyphicon glyphicon-pencil'></i> 编辑</button>&nbsp;";

                    if(row.status==2){
                        html += "<button class='btn btn-xs btn-warning' onclick='resume("
                            + id
                            + ")'><i class='fa fa-bus'></i> 恢复</button>&nbsp;";
                    }else{
                        html += "<button class='btn btn-xs btn-success' onclick='pause("
                            + id
                            + ")'><i class='fa fa-bus'></i> 暂停</button>&nbsp;";
                    }

                    html += "<button class='btn btn-xs btn-danger' onclick='del("
                        + id
                        + ",\"" + row.jobName + "\")'><i class='fa fa-times'></i> 删除</button>";
                    return html;
                }
            }]
        });

        /*分页查询结束*/

        $("#btnAddPage").click(function () {
            layer.open({
                title: ["添加任务", 'font-size:20px;'],
                type: 2,
                shadeClose: true,
                area: ['1024px', '600px'],
                fixed: false, //不固定
                maxmin: true,
                content: './job-add.html'
            });
        });

        $("#searchBtn").click(function () {
            page.search(getSearchParam());
        });


    });

    function getSearchParam() {
        //封装查询条件
        var param = new Object();
        param.jobName = $("#jobName").val();
        param.jobGroup = $("#jobGroup").val();
        param.status = $("#status").val();
        return param;
    }

    function del(id, name) {
        //询问框
        layer.confirm('确定要删除『' + name + '』吗？', {
            btn: ['确定', '取消'] //按钮
        }, function () {
            var param = new Object();
            param.id = id;
            $.ajax({
                url: getJobRemoveApi,
                type: 'POST',
                data: JSON.stringify(param), //传入已封装的参数
                contentType: "application/json; charset=utf-8",
                success: function () {
                    layer.msg("删除成功");
                    page.search();
                },
                error: function (e) {
                    layer.msg(e.responseJSON.message);
                }
            })
        }, function () {
            layer.msg('已取消');
        });
    }

    function edit(id) {
        //编辑产品
        layer.open({
            title: ["编辑任务", 'font-size:20px;'],
            type: 2,
            shadeClose: true,
            area: ['1024px', '600px'],
            fixed: false, //不固定
            maxmin: true,
            content: './job-edit.html?id='+id
        });
    }

    /**
     * 暂停
     */
    function pause(id) {
        //询问框
        layer.confirm('确定要暂停『' + id + '』吗？', {
            btn: ['确定', '取消'] //按钮
        }, function () {
            var param = new Object();
            param.id = id;
            $.ajax({
                url: pauseJobApi,
                type: 'POST',
                data: JSON.stringify(param), //传入已封装的参数
                contentType: "application/json; charset=utf-8",
                success: function (res) {
                    if(res.success){
                        layer.msg("暂停成功");
                        page.search();
                    }else{
                        layer.msg(res.msg);
                    }
                },
                error: function (e) {
                    layer.msg(e.responseJSON.message);
                }
            })
        }, function () {
            layer.msg('已取消');
        });
    }

    /**
     * 恢复
     */
    function resume(id) {
        //询问框
        layer.confirm('确定要恢复『' + id + '』吗？', {
            btn: ['确定', '取消'] //按钮
        }, function () {
            var param = new Object();
            param.id = id;
            $.ajax({
                url: resumeJobApi,
                type: 'POST',
                data: JSON.stringify(param), //传入已封装的参数
                contentType: "application/json; charset=utf-8",
                success: function (res) {
                    if(res.success){
                        layer.msg("恢复成功");
                        page.search();
                    }else{
                        layer.msg(res.msg);
                    }
                },
                error: function (e) {
                    layer.msg(e.responseJSON.message);
                }
            })
        }, function () {
            layer.msg('已取消');
        });
    }

    /**
     * 查看任务详情
     * @param id
     */
    function detail(id) {
        layer.open({
            title: "Job ["+id+"]",
            type: 2,
            shadeClose: true,
            area: ['1024px', '600px'],
            fixed: false, //不固定
            maxmin: true,
            content: './job-detail.html?id=' + id
        });
    }

    /**
     * 查看任务日志
     * @param id
     */
    function showLog(id) {
        layer.open({
            title: "任务["+id+"]日志",
            type: 2,
            shadeClose: true,
            area: ['1124px', '600px'],
            fixed: false, //不固定
            maxmin: true,
            content: './job-log-list.html?id=' + id
        });
    }

    // 列表倒计时刷新
    function listCountdown() {
        $(".nextFireTime").each(function () {
            var nextFireTime =  parseInt($(this).attr("data"));
            var status =  parseInt($(this).attr("status"));
            var isRetryEnd =  $(this).attr("isRetryEnd");
            if((status == 1) || (status == 4 && isRetryEnd == 'false')){ // 正常或者错误有下一次执行时间
                $(this).html(countdown(nextFireTime));
            }
        })
    }


    // 倒计时
    function countdown(nextTime) {
        if (nextTime != -1) {
            var nowTime = new Date().getTime();
            var residueTime = nextTime - nowTime;//剩余毫秒数

            if(residueTime>0){
                var residueSecond = parseInt(residueTime / 1000);//剩余秒数
                var residueMinute = parseInt(residueSecond / 60);//剩余分钟数
                var residueHour = parseInt(residueMinute / 60);//剩余小时数
                var residueDay = parseInt(residueHour / 24);//剩余天数
                // 倒计时时间取余
                residueHour = residueHour % 24;
                residueMinute = residueMinute % 60;
                residueSecond = residueSecond % 60;

                var residueTimeStr = '';
                if (residueDay > 0) {
                    residueTimeStr += residueDay + '天';
                }
                if (residueHour > 0) {
                    residueTimeStr += residueHour + '小时';
                }
                if (residueMinute > 0) {
                    residueTimeStr += residueMinute + '分钟';
                }
                if (residueSecond >= 0 && residueDay==0) {
                    residueTimeStr += residueSecond + '秒';
                }
                return '<font color="orange">'+residueTimeStr+'</font>';
            }else if(residueTime>-2000){
                page.search();
            }
            return '';
        }
    }

</script>
</body>
</html>
